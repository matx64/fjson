<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="fix any json" />
    <title>fjson | fix any json</title>

    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="./static/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="./static/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="./static/favicon-16x16.png"
    />
    <link rel="manifest" href="./static/site.webmanifest" />

    <link
      rel="preload"
      href="./pkg/fjson_wasm_bg.wasm"
      as="fetch"
      type="application/wasm"
      crossorigin="anonymous"
    />
    <link
      rel="preload"
      href="https://unpkg.com/normalize.css"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript
      ><link rel="stylesheet" href="https://unpkg.com/normalize.css"
    /></noscript>
    <link
      rel="preload"
      href="https://unpkg.com/magick.css"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript
      ><link rel="stylesheet" href="https://unpkg.com/magick.css"
    /></noscript>
    <style>
      html {
        min-height: 100vh;
        margin: 0;
      }

      main {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        gap: 3rem;
        text-align: center;
        max-width: 900px !important;
        padding: 1rem;
      }

      header,
      header * {
        margin: 0 !important;
      }

      section {
        flex-grow: 1;
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        align-items: stretch;
        justify-content: center;
        gap: 1rem;

        .textarea-div {
          flex-grow: 1;
          display: flex;
          flex-direction: column;
          min-width: 250px;

          .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
          }

          textarea {
            flex-grow: 1;
            border: 1px solid var(--form-fg-placeholder);
            font-family: "Courier Prime", monospace;
            font-size: medium;
            line-height: 1.2;
            min-height: 300px;
          }

          textarea:focus {
            outline: 2px solid var(--link-color);
            outline-offset: 2px;
          }
        }

        .controls-div {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          gap: 1rem;
          min-width: 120px;

          button {
            margin: 0;
            min-height: 48px;
            min-width: 120px;
            font-size: 1rem;
            font-weight: bold;
          }

          button:focus {
            outline: 2px solid var(--link-color);
            outline-offset: 2px;
          }

          button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
          }

          .loading-spinner {
            display: none;
            width: 24px;
            height: 24px;
            border: 3px solid var(--form-fg-placeholder);
            border-top-color: var(--link-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
          }

          .loading-spinner.active {
            display: block;
          }

          @keyframes spin {
            to {
              transform: rotate(360deg);
            }
          }

          .error-message {
            display: none;
            color: #dc2626;
            font-size: 0.875rem;
            padding: 0.5rem;
            border-radius: 4px;
            background-color: #fef2f2;
          }

          .error-message.active {
            display: block;
          }
        }
      }

      @media (max-width: 768px) {
        main {
          padding: 0.5rem;
          gap: 1.5rem;
        }

        section {
          flex-direction: column;
        }

        .textarea-div {
          width: 100%;

          textarea {
            min-height: 200px;
          }
        }

        .controls-div {
          flex-direction: row;
          width: 100%;
          padding: 0.5rem 0;

          button {
            flex-grow: 1;
            min-width: 120px;
          }
        }

        .header-row h2 {
          font-size: 1.25rem;
        }
      }

      .copy-btn {
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
        min-height: 32px;
        min-width: auto;
      }

      .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
        border-radius: 4px;
        background-color: #f3f4f6;
        color: #6b7280;
        margin-left: 0.5rem;
        vertical-align: middle;
        line-height: 1;
      }
    </style>
  </head>

  <body>
    <main>
      <header>
        <hgroup>
          <h1>fjson</h1>
          <p>fix <i>any</i> json</p>
        </hgroup>
      </header>

      <section>
        <div class="textarea-div">
          <div class="header-row">
            <h2>Input</h2>
            <button id="clear-btn" class="copy-btn" aria-label="Clear input">Clear</button>
          </div>
          <textarea id="json-input" placeholder="type your json" aria-label="JSON input"></textarea>
        </div>

        <div class="controls-div">
          <div class="loading-spinner" id="loading-spinner" aria-label="Loading"></div>
          <div class="error-message" id="error-message"></div>
          <button id="fix-btn" aria-label="Fix JSON" disabled>FIX</button>
        </div>

        <div class="textarea-div">
          <div class="header-row">
            <h2>Output <span id="status-badge" class="status-badge">Ready</span></h2>
            <button id="copy-btn" class="copy-btn" aria-label="Copy to clipboard" disabled>Copy</button>
          </div>
          <textarea id="json-output" aria-label="JSON output" readonly></textarea>
        </div>
      </section>

      <footer>
        © 2025-∞ fjson | <a href="https://github.com/matx64/fjson">source</a>
      </footer>
    </main>

    <script type="module">
      import init, { fix } from "./pkg/fjson_wasm.js";

      const input_element = document.getElementById("json-input");
      const output_element = document.getElementById("json-output");
      const fix_btn = document.getElementById("fix-btn");
      const clear_btn = document.getElementById("clear-btn");
      const copy_btn = document.getElementById("copy-btn");
      const loading_spinner = document.getElementById("loading-spinner");
      const error_message = document.getElementById("error-message");
      const status_badge = document.getElementById("status-badge");

      function show_error(message) {
        error_message.textContent = message;
        error_message.classList.add("active");
        setTimeout(() => {
          error_message.classList.remove("active");
        }, 5000);
      }

      function update_status(status) {
        status_badge.textContent = status;
      }

      async function copy_to_clipboard() {
        try {
          await navigator.clipboard.writeText(output_element.value);
          const original_text = copy_btn.textContent;
          copy_btn.textContent = "Copied!";
          setTimeout(() => {
            copy_btn.textContent = original_text;
          }, 2000);
        } catch (err) {
          show_error("Failed to copy to clipboard");
        }
      }

      clear_btn.addEventListener("click", () => {
        input_element.value = "";
        output_element.value = "";
        copy_btn.disabled = true;
        update_status("Ready");
        input_element.focus();
      });

      copy_btn.addEventListener("click", copy_to_clipboard);

      fix_btn.addEventListener("click", () => {
        try {
          const input_value = input_element.value;
          const fixed = fix(input_value);
          output_element.value = fixed;
          copy_btn.disabled = false;
          update_status("Fixed");
        } catch (err) {
          show_error("Failed to fix JSON: " + err.message);
          update_status("Error");
        }
      });

      loading_spinner.classList.add("active");
      update_status("Loading...");

      init()
        .then(() => {
          loading_spinner.classList.remove("active");
          fix_btn.disabled = false;
          update_status("Ready");
          input_element.value = "";
          output_element.value = "";
          input_element.focus();
        })
        .catch((err) => {
          loading_spinner.classList.remove("active");
          show_error("Failed to initialize WASM: " + err.message);
          update_status("Error");
          console.error("WASM initialization failed:", err);
        });
    </script>
  </body>
</html>
